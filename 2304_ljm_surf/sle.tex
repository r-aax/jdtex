Основной проблемой, с которой можно потенциально столкнуться при эволюции расчетной сетки, является возникновение самопересечений.
Самопересечение является критическим дефектом сетки, при котором невозможно производить дальнейшие вычисления по моделированию ледообразования, поэтому самопересечения необходимо удалять.
Во-первых, необходимо определить, какое отношение двух ячеек сетки можно трактовать как самопересечение.
Конечно, простое наличие общих точек у двух ячеек не может служить критерием самопересечения, так как у каждой ячейки есть смежные ячейки (то есть две ячейки могут иметь как общую вершину, так и общее ребро).
Так как смежными могут быть только ячейки, имеющие общие инцидентные объекты (общую инцидентную вершину или общее инцидентное ребро), а все отношения инцидентности прописаны в расчетной сетке, то не представляет труда отделить пересечение ячеек по общему инцидентному объекту от самопересечения.

\subsection{Поиск пар пересекающихся треугольников}

В любом случае для идентификации всех фактов самопересечения сетки требуется проанализировать все пары ячеек и проверить пересечение ячеек в паре (то есть проверить пересечение каждой ячейки с каждой).
Так как прямой перебор всех пар ячеек имеет квадратичную сложность по количеству ячеек в сетке, то его использование на крупных сетках невозможно.
В этом случае целесообразно выполнять поиск пар пересекающихся ячеек с помощью представления множества ячеек в виде специальной древовидной структуры, связанной с ограничением геометрических объектов прямоугольными параллелепипедами в пространстве.
Для начала определим понятие контейнера для произвольного множества точек $M$ в пространстве (будем обозначать его через $[M]$): $[M]$ -- это прямоугольный параллелепипед, являющийся декартовым произведением трех сегментов

\begin{equation}
[M] = \left[\min_{P \in M}{P_x}, \max_{P \in M}{P_x}\right]
      \times \left[\min_{P \in M}{P_y}, \max_{P \in M}{P_y}\right]
      \times \left[\min_{P \in M}{P_z}, \max_{P \in M}{P_z}\right]
\end{equation}

Контейнер можно рассматривать для произвольного множества точек.
Мы будем его использовать для ячейки расчетной сетки, а также для множества ячеек.
Так как любой треугольник является выпуклой фигурой, то $[ABC] = [\{A, B, C\}]$, то есть для построения контейнера для треугольника достаточно рассмотреть только его вершины.
При поиске пар пересекающихся ячеек будем использовать следующий факт: если два треугольника пересекаются, то пересекаются и их контейнеры: $ABC \cap A'B'C' \ne \emptyset \Rightarrow [ABC] \cap [A'B'C'] \ne \emptyset$.
А значит если не пересекаются контейнеры двух треугольников, то не пересекаются и сами треугольники: $[ABC] \cap [A'B'C'] = \emptyset \Rightarrow ABC \cap A'B'C' = \emptyset$.
В отличие от анализа пары треугольников на пересечение, проверка на пересечение двух прямоугольных параллелепипедов со сторонами, параллельными координатным осям, не представляет проблем.
То есть па первом этапе будем искать такие пары ячеек, чьи контейнеры пересекаются (будем называть их потенциально пересекающимися ячейками).

\begin{figure}[h]
\includegraphics[width=0.8\textwidth]{pics/pic_box_size.pdf}
\captionstyle{center}\caption{Схема построения дерева контейнеров.}\label{fig:pic_box}
\end{figure}

Для поиска потенциально пересекающихся ячеек построим дерево контейнеров всех ячеек сетки.
Корнем данного дерева будет являться контейнер всех ячеек расчетной сетки.
Рассмотрим процедуру разделения контейнера на два более мелких на примере двумерного случая, проиллюстрированного на Fig.~\ref{fig:pic_box}.
Путь мы хотим разделить контейнер некоторого множества треугольников ($M$) по горизонтальной прямой на два множества: верхнее ($U$) и нижнее ($D$).
Тогда в верхнее множество попадут все треугольники, лежащие выше прямой, либо пересекающие ее.
Аналогично в нижнее множество попадут все треугольники, лежащие ниже прямой, либо пересекающие ее.
После выделения верхнего и нижнего множества треугольников, для каждого из них строятся свои контейнеры, которые становятся дочерними контейнерами исходного.
После этого получившиеся контейнеры можно делить дальше, используя произвольное направление разбиения ($X$, $Y$, $Z$).
В частности на Fig.~\ref{fig:pic_box} продемонстрировано разбиение исходного контейнера по схеме $[M] \rightarrow \{[U], [D]\} \rightarrow \{\{[UL], [UR]\}, \{[DL], [DR]\}\}$.
Следует заметить, что за одну операцию контейнер можно разбивать на произвольное количество дочерних контейнеров аналогичным образом.
В качестве же направления разбиения контейнера целесообразно выбирать наиболее протяженное (вдоль которого длина контейнера имеет наибольшее значение).

Построенное дерево контейнеров позволяет существенно сократить количество проверяемых потенциальных пересечений треугольников \cite{Jung}, так как если $[M] \cap [M'] = \emptyset$, $[T]$ -- дочерний контейнер для $[M]$, а $[T']$ -- дочерний контейнер для $[M']$, то $[T] \cap [T'] = \emptyset$.

После того, как найдены все пары потенциально пересекающихся треугольников, необходимо проверить, пересекаются ли они на самом деле.
Так как треугольник является выпуклой фигурой, то пересечение двух треугольников также является выпуклой фигурой (это может быть любая плоская фигура с количеством вершин от 1 до 6).
Вершинами пересечения двух треугольников являются точки пересечения сторон одного треугольника с другим треугольником и наоборот.
Таким образом задача поиска пересечения двух треугольников сводится к поиску точек пересечения треугольника и отрезка.
Данная задача может быть решена, с помощью представления треугольника $ABC$ в виде геометрического места точек $\vec{P} = \vec{A} + \beta \vec{AB} + \gamma \vec{AC}$, $\beta \ge 0$, $\gamma \ge 0$, $\beta + \gamma \le 1$, представления отрезка $QR$ в виде геометрического места точек $\vec{P} = \vec{Q} + \phi \vec{QR}$, $0 \le \phi \le 1$ и поиска решения системы уравнений $\vec{A} + \beta \vec{AB} + \gamma \vec{AC} = \vec{Q} + \phi \vec{QR}$ относительно неизвестных $\beta$, $\gamma$, $\phi$ с учетом ограничений \cite{Freylekhman}.

\subsection{Фиксация пересекающихся треугольников}

После того, как найдены все пары пересекающихся ячеек и области их пересечения, необходимо определить стратегию их устранения.
Все ячейки расчетной сетки можно разделить на три категории.
Первая категория -- ячейки, которые не пересекаются ни с какими другими ячейками, и которые должны стать частью итоговой поверхности (будем считать, что в любой момент времени у нас есть возможность указать произвольное количество таких ячеек).
Будем такие ячейки называть статические.
Вторая категория -- ячейки, которые не пересекаются ни с какими другими ячейками, но которые не должны стать частью итоговой поверхности (ячейки внутренних петель самопересечения поверхности, которые должны быть удалены).
Такие ячейки будем называть скрытыми.
Третья категория -- ячейки, которые пересекаются с какими-то другими ячейками. 
Такие ячейки будем называть ячейками пересечения.

\begin{figure}[h]
  \centering
  \begin{minipage}[h]{0.32\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_zip_01.png}
    \caption{Пересечение расчетных сеток для двух сфер.}\label{fig:pic_zip_01}
  \end{minipage}
  \hfill
  \begin{minipage}[h]{0.32\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_zip_09.png}
    \caption{Грубое удаление ячеек пересечения.}\label{fig:pic_zip_09}
  \end{minipage}
  \hfill
  \begin{minipage}[h]{0.32\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_zip_15.png}
    \caption{Удаление ячеек пересечения после дробления.}\label{fig:pic_zip_15}
  \end{minipage}
\end{figure}

Одним из подходов к устранению самопересечений сетки является просто удаление всех ячеек пересечения.
После выполнения этой операции сетка распадается на области статических и скрытых ячеек.
При этом скрытые ячейки являются недостижимыми из статических при выполнении обхода ячеек расчетной сетки (если в процессе обхода соседними считаются только ячейки, смежные по ребру).
После удаления из сетки скрытых ячеек расчетная сетка состоит только из статических ячеек, однако требуется добавление новых ячеек для восстановления целостности сетки \cite{Charton}.
Такой подход к устранению самопересечений сетки может применяться для сравнительно простых поверхностей, но в общем случае он не гарантирует получение корректного результата.
В качестве иллюстрации такого способа устранения пересечений на Fig.~\ref{fig:pic_zip_01}, Fig.~\ref{fig:pic_zip_09} приведен пример работы для устранения пересечений расчетных сеток двух сфер (новые ячейки, появляющиеся при восстановлении сетки отмечены зеленым цветом).
На Fig.~\ref{fig:pic_zip_09} можно отметить, достаточно низкое качество результирующей сетки.
Повысить качество можно с помощью дробления ячеек пересечения.
То есть после поиска всех ячеек пересечения, их необходимо раздробить на более мелкие (как показано на Fig.~\ref{fig:pic_delaunay_2}), после чего повторить процедуру удаления ячеек пересечения и скрытых ячеек и выполнить восстановление сетки.
Процесс дробления ячеек пересечения можно повторять многократно, при этом качество результирующей сетки будет повышаться, как это показано на Fig.~\ref{fig:pic_zip_15}.

При другом подходе устранения самопересечений никакие ячейки из сетки не удаляются, а дробятся на более мелкие по всем точкам пересечения \cite{Skvorkovska}.
В качестве примера на Fig.~\ref{fig:pic_after_cut} показаны два треугольника, которые пересекаются по отрезку (две точки пересечения).
После выполнения дробления получаем конструкцию, показанную на Fig.~\ref{fig:pic_after_cut}.
В общем случае точек, по которым необходимо разбивать ячейку, может быть сколь угодно много, и дробление должно выполняться с помощью выполнения триангуляции по этим точкам, причем некоторые ребра триангуляции должны быть фиксированы.

\begin{figure}[h]
  \centering
  \begin{minipage}[h]{0.4\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_before_cut.png}
    \caption{Два пересекающихся треугольника до дробления.}\label{fig:pic_before_cut}
  \end{minipage}
  \begin{minipage}[h]{0.4\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_after_cut.png}
    \caption{Ячейки после дробления по точкам пересечения.}\label{fig:pic_after_cut}
  \end{minipage}
\end{figure}

После дробления ячеек по точкам пересечения, между ячейками сетки могут остаться только следующие виды отношений: две ячейки не имеют общих точек, две ячейки имеют одну общую вершину, две ячейки имеют одно общее ребро.
При этом в сетке появляются ребра, имеющие более двух инцидентных ячеек.
Если наложить на исходную сетку два дополнительных условия, которые могут быть достигнуты с помощью локальных преобразований сетки, то можно добиться достаточно простой структуры сетки (такие сетки будем называть простыми).
Первым условием будем считать отсутствие в сетке совпадающих вершин.
Вторым условием будем считать то, что никакой узел сетки не находится ни в какой другой ячейке.
При выполнении этих двух дополнительных условий можно утверждать, что если ребро имеет более двух инцидентных ячеек, то это количество в точности равно 4, причем эти 4 инцидетные ячейки попарно находятся в одной плоскости.

\begin{figure}[h]
\includegraphics[width=1.0\textwidth]{pics/pic_walk_1_size.pdf}
\captionstyle{center}\caption{Схема обхода результирующей поверхности.}\label{fig:pic_walk}
\end{figure}

Для получения результирующей поверхности необходимо избавиться от лишних ячеек, чтобы у каждого ребра вновь осталось ровно по 2 инцидентные ячейки.
Для этого нужно выполнить обход сетки, начиная с любой статической ячейки, считая соседними две ячейки, имеющие общее инцидентное ребро (помечаемые в процессе обхода ячейки попадут в результирующую сетку).
При движении от некоторой ячейки через ребро, имеющее более двух инцидентных ячеек, возникает вопрос выбора ячейки, которая должна войти в результирующую сетку (при этом все остальные ячейки должны быть удалены).

Рассмотрим процедуру выбора следующей ячейки обхода сетки для ребер, имеющих количество инцидентных ячеек, больше двух (Fig.~\ref{fig:pic_walk}, в центре).
На данном рисунке обозначено направление обхода слева направо, вслед за ячейкой, инцидентной вершине $A$, в результирующую сетку должна войти ячейка, инцидентная вершине $B$.
Рассмотрим эту процедуру для простых сеток, а также для сеток в общем виде.
Для простоты будем рассматривать задачу в проекции на плоскость, перпендикулярную ребру.

Для начала будем считать, что имеет место случай простой сетки (Fig.~\ref{fig:pic_walk}, слева).
Пусть уже известно, что ячейка, инцидентная вершине $A$, помечена, а ее внешняя нормаль равна $\vec{n}_A$.
Из оставшихся трех ячеек (инцидентных вершинам $B$, $C$, $D$ соответственно) необходимо выбрать только одну для продолжения обхода сетки, а остальные удалить.
Так как сетка у нас простая, то $\angle AOC = \angle BOD = 2 \pi$, а значит $(\vec{n}_A, \vec{OB}) > 0$, $(\vec{n}_A, \vec{OC}) = 0$, $(\vec{n}_A, \vec{OD}) < 0$.
Таким образом, из всех ячеек, необходимо выбрать ту, для которой значение $(\vec{n}_A, \vec{OP})$ максимально.

Теперь рассмотрим расчетную сетку в общем виде.
В этом случае количество ячеек, инцидентных рассматриваемому ребру, может быть произвольным, больше двух, а про значение функции $(\vec{n}_A, \vec{OP})$ сказать ничего нельзя.
Для выбора следующей ячейки для обхода сетки будем поворачивать текущую ячейку вокруг рассматриваемого ребра в направлении $\vec{n}_A$ до совпадения с первой ячейкой (Fig.~\ref{fig:pic_walk}, справа).
Первая ячейка и должна быть выбрана в качестве следующей для продолжения обхода.
Если через $\phi(A \rightarrow P)$  обозначить угол поворота исходной ячейки в направлении $\vec{n}_A$ до ячеки, инцидентной вершине $P$, то в качестве следующей ячейки для обхода необходимо выбрать ту, для которой $\phi(A \rightarrow B)$ будет минимально.

Объединяя вместе оба рассмотренных случая, получаем критерий выбора следующей для обхода ячейки: должна быть выбрана ячейка, для которой значение показателя $f(P)$ максимально, где

\begin{equation}
f(P) = 
\begin{cases}
(\vec{n}_A, \vec{OP}), \text{для простых сеток}, \\
-\phi(A \rightarrow P), \text{для сеток общего вида}
\end{cases}
\end{equation}

После завершения обхода расчетной сетки все помеченные ячейки считаются ячейками целевой поверхности, а все остальные ячейки должны быть удалены.
На рисунках Fig.~\ref{fig:pic_self_intersection_on} - Fig.~\ref{fig:pic_self_intersection_off_2} проиллюстрированы примеры устранения самопересечений сетки в виде скрытых петель.
После удаления скрытых ячеек целевая расчетная сетка снова становится корректной, удовлетворяет соотношениям (\ref{eq_arch}) и может быть использована для дальнейшего моделирования ледообразования.

\begin{figure}[h]
  \centering
  \begin{minipage}[h]{0.49\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_self_intersection_on.png}
    \caption{Поверхность до удаления самопересечения.}\label{fig:pic_self_intersection_on}
  \end{minipage}
  \hfill
  \begin{minipage}[h]{0.49\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_self_intersection_off.png}
    \caption{Поверхность после удаления самопересечения.}\label{fig:pic_self_intersection_off}
  \end{minipage}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{minipage}[h]{0.49\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_self_intersection_on_2.png}
    \caption{Поверхность до удаления самопересечения.}\label{fig:pic_self_intersection_on_2}
  \end{minipage}
  \hfill
  \begin{minipage}[h]{0.49\textwidth}
    \includegraphics[width=\textwidth]{pics/pic_self_intersection_off_2.png}
    \caption{Поверхность после удаления самопересечения.}\label{fig:pic_self_intersection_off_2}
  \end{minipage}
\end{figure}
